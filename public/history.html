<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³¨æ–‡å±¥æ­´ - ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/components.css">
</head>

<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/home.html" class="sidebar-logo">Think Body Japan</a>
      </div>
      <nav class="sidebar-nav">
        <a href="/home.html" class="nav-item"><span class="nav-item-icon">ğŸ </span> ãƒ›ãƒ¼ãƒ </a>
        <a href="/order.html" class="nav-item"><span class="nav-item-icon">ğŸ›’</span> æ–°è¦æ³¨æ–‡</a>
        <a href="/history.html" class="nav-item active"><span class="nav-item-icon">ğŸ“‹</span> æ³¨æ–‡å±¥æ­´</a>
        <a href="/profile.html" class="nav-item"><span class="nav-item-icon">ğŸ‘¤</span> ä¼šå“¡æƒ…å ±</a>
        <a href="/shipping.html" class="nav-item"><span class="nav-item-icon">ğŸ“¦</span> é…é€å…ˆç®¡ç†</a>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()" class="btn btn-outline btn-block">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </aside>

    <main class="main-content">
      <header class="header">
        <h1 class="header-title">æ³¨æ–‡å±¥æ­´</h1>
      </header>

      <div class="content">
        <div id="alert-container"></div>
        <div class="card">
          <div class="card-body">
            <div id="orders-container"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- æ³¨æ–‡è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="order-detail-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">æ³¨æ–‡è©³ç´°</h3>
        <button class="modal-close" onclick="closeModal('order-detail-modal')">Ã—</button>
      </div>
      <div class="modal-body" id="order-detail-content"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('order-detail-modal')">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script src="/js/utils.js"></script>
  <script>
    async function loadOrders() {
      try {
        const orders = await apiRequest('/api/orders');
        const container = document.getElementById('orders-container');

        if (orders.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“¦</div>
              <h3 class="empty-state-title">æ³¨æ–‡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
              <p class="empty-state-description">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              <a href="/order.html" class="btn btn-primary">æ–°è¦æ³¨æ–‡</a>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>æ³¨æ–‡ID</th>
                  <th>å•†å“</th>
                  <th>æ•°é‡</th>
                  <th>å˜ä¾¡</th>
                  <th>åˆè¨ˆé‡‘é¡</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ³¨æ–‡æ—¥æ™‚</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map(order => `
                  <tr>
                    <td>#${order.id}</td>
                    <td>BASE</td>
                    <td>${order.quantity}è¢‹</td>
                    <td>${formatPrice(order.unit_price)}</td>
                    <td>${formatPrice(order.total_price)}</td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>
                      <div style="display: flex; gap: 4px;">
                        <button class="btn btn-sm btn-outline" onclick="viewOrderDetail(${order.id})">è©³ç´°</button>
                        <button class="btn btn-sm btn-outline" onclick="window.open('/api/orders/${order.id}/receipt', '_blank')" title="é ˜åæ›¸ç™ºè¡Œ">ğŸ§¾</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Orders error:', error);
        showAlert('æ³¨æ–‡å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    async function viewOrderDetail(orderId) {
      try {
        const order = await apiRequest(`/api/orders/${orderId}`);
        const content = document.getElementById('order-detail-content');

        // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°çŠ¶æ³ã®è¨ˆç®—
        const statuses = ['å—ä»˜', 'æº–å‚™ä¸­', 'ç™ºé€å®Œäº†', 'åˆ°ç€'];
        // æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œå‡¦ç†ä¸­ã€ã‚’ã€Œå—ä»˜ã€ã¨ã—ã¦æ‰±ã†
        const currentStatus = order.status === 'å‡¦ç†ä¸­' ? 'å—ä»˜' : order.status;
        const statusIndex = statuses.indexOf(currentStatus);

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®HTMLç”Ÿæˆ
        let trackingHtml = '';
        if (statusIndex !== -1) {
          const progressPercent = statusIndex * 33.33;
          trackingHtml = `
            <div class="tracking-container">
              <div class="tracking-steps">
                <div class="tracking-progress-fill" style="width: ${progressPercent}%;"></div>
                ${statuses.map((s, idx) => {
            let className = 'tracking-step';
            if (idx < statusIndex) className += ' completed';
            if (idx === statusIndex) className += ' active';
            return `
                    <div class="${className}">
                      <div class="tracking-dot"></div>
                      <div class="tracking-label">${s}</div>
                    </div>
                  `;
          }).join('')}
              </div>
            </div>
          `;
        }

        content.innerHTML = `
          ${trackingHtml}
          
          <div style="margin-bottom: var(--spacing-lg);">
            <h4 style="margin-bottom: var(--spacing-md);">æ³¨æ–‡æƒ…å ±</h4>
            <div style="display: grid; gap: var(--spacing-sm);">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">æ³¨æ–‡ID:</span>
                <span>#${order.id}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">å•†å“:</span>
                <span>BASE(ã‚³ã‚³ã‚¢å‘³)</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">æ•°é‡:</span>
                <span>${order.quantity}è¢‹</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">å˜ä¾¡:</span>
                <span>${formatPrice(order.unit_price)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; font-weight: var(--font-weight-bold);">
                <span>åˆè¨ˆé‡‘é¡:</span>
                <span style="color: var(--color-accent);">${formatPrice(order.total_price)}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
                <span>${getStatusBadge(order.status)}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-text-secondary);">æ³¨æ–‡æ—¥æ™‚:</span>
                <span>${formatDate(order.created_at)}</span>
              </div>
            </div>
          </div>

          ${order.shipping_address ? `
            <div>
              <h4 style="margin-bottom: var(--spacing-md);">é…é€å…ˆæƒ…å ±</h4>
              <div style="background-color: var(--color-bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius-md);">
                <p style="margin-bottom: var(--spacing-xs);"><strong>${order.shipping_address.label}</strong></p>
                <p style="margin-bottom: var(--spacing-xs);">ã€’${order.shipping_address.postal_code}</p>
                <p style="margin-bottom: var(--spacing-xs);">${order.shipping_address.address}</p>
                <p>TEL: ${order.shipping_address.phone}</p>
              </div>
            </div>
          ` : ''}
          
          <!-- é ˜åæ›¸ç™ºè¡Œãƒœã‚¿ãƒ³ -->
          <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border); text-align: right;">
            <button class="btn btn-primary" onclick="window.open('/api/orders/${order.id}/receipt', '_blank')">
              ğŸ§¾ é ˜åæ›¸ç™ºè¡Œ
            </button>
          </div>
        `;

        openModal('order-detail-modal');
      } catch (error) {
        console.error('Order detail error:', error);
        showAlert('æ³¨æ–‡è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    loadOrders();
  </script>
</body>

</html>