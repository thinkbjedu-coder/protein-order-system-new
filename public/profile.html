<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå“¡æƒ…å ± - ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/components.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/home.html" class="sidebar-logo">Think Body Japan</a>
            </div>
            <nav class="sidebar-nav">
                <a href="/home.html" class="nav-item"><span class="nav-item-icon">ğŸ </span> ãƒ›ãƒ¼ãƒ </a>
                <a href="/order.html" class="nav-item"><span class="nav-item-icon">ğŸ›’</span> æ–°è¦æ³¨æ–‡</a>
                <a href="/history.html" class="nav-item"><span class="nav-item-icon">ğŸ“‹</span> æ³¨æ–‡å±¥æ­´</a>
                <a href="/profile.html" class="nav-item active"><span class="nav-item-icon">ğŸ‘¤</span> ä¼šå“¡æƒ…å ±</a>
                <a href="/shipping.html" class="nav-item"><span class="nav-item-icon">ğŸ“¦</span> é…é€å…ˆç®¡ç†</a>
            </nav>
            <div class="sidebar-footer">
                <button onclick="logout()" class="btn btn-outline btn-block">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1 class="header-title">ä¼šå“¡æƒ…å ±</h1>
            </header>

            <div class="content">
                <div id="alert-container"></div>
                <form id="profile-form" class="card">
                    <div class="card-header">
                        <h3 class="card-title">åŸºæœ¬æƒ…å ±</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                            <div class="form-group">
                                <label class="form-label required">å§“</label>
                                <input type="text" class="form-input" name="last_name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">å</label>
                                <input type="text" class="form-input" name="first_name" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">äº‹æ¥­è€…å</label>
                            <input type="text" class="form-input" name="company_name" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" class="form-input" name="email" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">é›»è©±ç•ªå·</label>
                            <input type="tel" class="form-input" name="phone" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">éƒµä¾¿ç•ªå·</label>
                            <input type="text" class="form-input" name="postal_code">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ä½æ‰€</label>
                            <input type="text" class="form-input" name="address">
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">æ›´æ–°ã™ã‚‹</button>
                    </div>
                </form>

                <form id="password-form" class="card" style="margin-top: var(--spacing-xl);">
                    <div class="card-header">
                        <h3 class="card-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label required">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" class="form-input" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" class="form-input" name="new_password" required placeholder="8æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                            <input type="password" class="form-input" name="new_password_confirm" required>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="/js/utils.js"></script>
    <script>
        async function loadProfile() {
            try {
                const user = await apiRequest('/api/me');
                const form = document.getElementById('profile-form');

                form.elements.last_name.value = user.last_name;
                form.elements.first_name.value = user.first_name;
                form.elements.company_name.value = user.company_name;
                form.elements.email.value = user.email;
                form.elements.phone.value = user.phone;
                form.elements.postal_code.value = user.postal_code || '';
                form.elements.address.value = user.address || '';
            } catch (error) {
                console.error('Profile load error:', error);
                showAlert('ä¼šå“¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        const profileForm = document.getElementById('profile-form');
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = profileForm.querySelector('button[type="submit"]');
            showLoading(submitBtn);

            try {
                const data = getFormData(profileForm);
                // delete data.email; // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚æ›´æ–°å¯¾è±¡

                const result = await apiRequest('/api/profile', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                showAlert(result.message, 'success');
                hideLoading(submitBtn);
            } catch (error) {
                showAlert(error.message, 'error');
                hideLoading(submitBtn);
            }
        });

        const passwordForm = document.getElementById('password-form');
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = passwordForm.querySelector('button[type="submit"]');
            const data = getFormData(passwordForm);

            if (data.new_password !== data.new_password_confirm) {
                showAlert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            if (data.new_password.length < 8) {
                showAlert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showLoading(submitBtn);

            try {
                const result = await apiRequest('/api/profile/password', {
                    method: 'PUT',
                    body: JSON.stringify({
                        currentPassword: data.current_password,
                        newPassword: data.new_password
                    })
                });

                showAlert(result.message, 'success');
                passwordForm.reset();
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                hideLoading(submitBtn);
            }
        });

        loadProfile();
    </script>
</body>

</html>